"""FastAPI application entry point."""
import logging
from contextlib import asynccontextmanager
from fastapi import FastAPI, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse
from app.config import get_settings
from app.routers import (
    # CS1
    health_router,
    companies_router,
    assessments_router,
    scores_router,
    # CS2
    documents_router,
    signals_router,
    evidence_router,
    report_router,
)

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s"
)
logger = logging.getLogger(__name__)


@asynccontextmanager
async def lifespan(app: FastAPI):
    """Application lifespan handler for startup/shutdown."""
    # Startup
    logger.info("Starting PE Org-AI-R Platform...")
    settings = get_settings()
    logger.info(f"Environment: {'DEBUG' if settings.debug else 'PRODUCTION'}")
    yield
    # Shutdown
    logger.info("Shutting down PE Org-AI-R Platform...")


def create_app() -> FastAPI:
    """Create and configure the FastAPI application."""
    settings = get_settings()
    
    app = FastAPI(
        title=settings.app_name,
        description="""
        ## PE Org-AI-R Platform API
        
        AI-Readiness Assessment Platform for Private Equity
        
        ### Features:
        - Company management with industry classification
        - Assessment lifecycle management
        - Seven-dimension AI-readiness scoring
        - Caching for optimized performance
        - **[CS2] SEC document collection and parsing**
        - **[CS2] External signal collection (jobs, patents, tech stack)**
        - **[CS2] Evidence aggregation and statistics**
        
        ### Assessment Types:
        - **Screening**: Quick external assessment
        - **Due Diligence**: Deep dive with internal access
        - **Quarterly**: Regular portfolio monitoring
        - **Exit Prep**: Pre-exit assessment
        
        ### Evidence Collection (CS2):
        - **Documents**: SEC 10-K, 10-Q, 8-K filings
        - **Signals**: Job postings, technology stack, patents
        """,
        version=settings.app_version,
        lifespan=lifespan,
        docs_url="/docs",
        redoc_url="/redoc",
        openapi_url="/openapi.json"
    )
    
    # CORS middleware
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],  # Configure appropriately for production
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # --- CS1 Routers ---
    app.include_router(health_router)
    app.include_router(companies_router)
    app.include_router(assessments_router)
    app.include_router(scores_router)
    # --- CS2 Routers ---
    app.include_router(documents_router)
    app.include_router(signals_router)
    app.include_router(evidence_router)
    app.include_router(report_router)
    # Global exception handler
    @app.exception_handler(Exception)
    async def global_exception_handler(request: Request, exc: Exception):
        logger.error(f"Unhandled exception: {exc}", exc_info=True)
        return JSONResponse(
            status_code=500,
            content={"detail": "Internal server error", "error": str(exc)}
        )
    
    return app


# Create app instance
app = create_app()


if __name__ == "__main__":
    import uvicorn
    uvicorn.run("app.main:app", host="0.0.0.0", port=8000, reload=True)